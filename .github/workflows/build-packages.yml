name: Build packages
on:
  workflow_dispatch:
    inputs:
      x86_64:
        required: false
        type: boolean
        description: If build for x86_64 architecture
        default: true
      aarch64:
        required: false
        type: boolean
        description: If build for aarch64 architecture
        default: false
  schedule:
    - cron: '0 22 * * *'
jobs:
  prepare:
    name: Prepare contents required by building
    runs-on: ubuntu-latest
    outputs:
      runs-on: ${{ steps.generate.outputs.runs-on }}
      image-filename: ${{ steps.build.outputs.image-filename }}
      image-artifact-id: ${{ steps.upload.outputs.artifact-id }}
    steps:
      - name: Generate information
        id: generate
        run: |
          # Add more architecture-runner pairs here.
          declare -A runner_map=([x86_64]=ubuntu-24.04
                                 [aarch64]=ubuntu-24.04-arm)
          runs_on=()
          platforms=()
          case '${{ github.event_name }}' in
            "schedule")
              runs_on+=("${runner_map["x86_64"]}")
              platforms+=("linux/amd64")
              ;;
            "workflow_dispatch")
              if '${{ inputs.x86_64 }}'
              then
                runs_on+=("${runner_map["x86_64"]}")
                platforms+=("linux/amd64")
              fi
              if '${{ inputs.aarch64 }}'
              then
                runs_on+=("${runner_map["aarch64"]}")
                platforms+=("linux/arm64")
              fi
              ;;
            *)
              echo '::error::Unable to generate information for event ${{ github.event_name }}.'
              exit 1
              ;;
          esac
          {
            echo "runs-on=$(jq --null-input --compact-output '$ARGS.positional' --args "${runs_on[@]}")"
            echo -n "platforms=${platforms[0]}"
            if [[ "${#platforms[@]}" -gt 1 ]]
            then
              printf ",%s" "${platforms[@]:1}"
            fi
            echo
          } >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v6

      - name: Build makepkg
        id: build
        uses: ./.github/actions/build-makepkg
        with:
          platforms: ${{ steps.generate.outputs.platforms }}

      - name: Upload image
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: ghcr.io-${{ github.repository_owner }}-makepkg-${{ github.sha }}
          path: ${{ steps.build.outputs.image-path }}
          
  
  tier0-packages:
    needs: prepare
    strategy:
      matrix:
        runs-on: ${{ fromJSON(needs.prepare.outputs.runs-on) }}
        package:
          - type: aur
            pkgbase: ares-decrypt
          - type: aur
            pkgbase: aria2cd
          - type: aur
            pkgbase: ariang-git
            devel: true
          - type: aur
            pkgbase: ariang-native-git
            devel: true
          - type: aur
            pkgbase: ayugram-desktop
            clean-runner: true
            set-swap: 32G
          - type: aur
            pkgbase: basedpyright
          - type: aur
            pkgbase: binder_linux-dkms
          - type: local
            pkgbase: caddy-cloudflare
          - type: aur
            pkgbase: carapace
          - type: aur
            pkgbase: cgtproxy
          - type: aur
            pkgbase: chromium-extension-plasma-integration
          - type: aur
            pkgbase: chromium-extension-web-store
          - type: aur
            pkgbase: cinny
            preserve-env: cinnyBase
          - type: aur
            pkgbase: cleanmedia
          - type: aur
            pkgbase: cloudflarespeedtest
          - type: aur
            pkgbase: crow-translate
          - type: aur
            pkgbase: csharp-ls
          - type: aur
            pkgbase: ctre
          - type: aur
            pkgbase: cubeb
          - type: aur
            pkgbase: dendrite
          - type: aur
            pkgbase: docker-language-server
          - type: aur
            pkgbase: dotnet-install
          - type: aur
            pkgbase: downgrade
          - type: local
            pkgbase: easytier
          - type: aur
            pkgbase: fcitx5-pinyin-custom-pinyin-dictionary
          - type: aur
            pkgbase: fcitx5-pinyin-moegirl
          - type: aur
            pkgbase: ffmpeg-audio-thumbnailer
          - type: aur
            pkgbase: find-the-command
          - type: aur
            pkgbase: firefox-extension-adguard
          - type: aur
            pkgbase: firefox-extension-localcdn
          - type: local
            pkgbase: flatpak-builder-tools-git
            devel: true
          - type: aur
            pkgbase: go.rice
          - type: aur
            pkgbase: gpt4all-chat
          - type: aur
            pkgbase: hath-rust
          - type: aur
            pkgbase: icalingua++-git
            devel: true
          - type: aur
            pkgbase: icecream
          - type: aur
            pkgbase: icoextract
          - type: aur
            pkgbase: kde-thumbnailer-apk
          - type: aur
            pkgbase: ksmbd-tools
          - type: aur
            pkgbase: libbase58
          - type: aur
            pkgbase: libvgm-git
            devel: true
          - type: aur
            pkgbase: linux-pf
            clean-runner: true
          - type: aur
            pkgbase: lyrica
          - type: aur
            pkgbase: mpv-memo-git
            devel: true
          - type: aur
            pkgbase: mpv-thumbfast-noenabled-git
            devel: true
          - type: aur
            pkgbase: mpv-uosc
          - type: aur
            pkgbase: naiveproxy
          - type: aur
            pkgbase: needrestart
          - type: local
            pkgbase: neocmakelsp
          - type: aur
            pkgbase: netcoredbg
          - type: aur
            pkgbase: nodejs-jsonlint
          - type: aur
            pkgbase: ntfysh
          - type: aur
            pkgbase: nvidia-580xx-utils
          - type: aur
            pkgbase: obs-pipewire-audio-capture
          - type: aur
            pkgbase: oh-my-posh
          - type: aur
            pkgbase: openwrt-devel
          - type: aur
            pkgbase: osc
          - type: local
            pkgbase: osu-lazer-bin
          - type: aur
            pkgbase: paccache-hook
          - type: aur
            pkgbase: paru
          - type: aur
            pkgbase: pay-respects
          - type: aur
            pkgbase: phonon-mpv
          - type: aur
            pkgbase: pipewire-module-xrdp
          - type: aur
            pkgbase: pipewire-module-xrdp-git
            devel: true
          - type: aur
            pkgbase: plasma-gamemode-git
            devel: true
          - type: aur
            pkgbase: plasma6-applets-caraoke-git
            devel: true
          - type: aur
            pkgbase: plasma6-wallpapers-wallpaper-engine-git
            devel: true
          - type: aur
            pkgbase: protoc-gen-go
          - type: aur
            pkgbase: python-fvs
          - type: aur
            pkgbase: python-pathvalidate
          - type: aur
            pkgbase: python-pyclip
          - type: aur
            pkgbase: python-setuptools-reproducible
          - type: aur
            pkgbase: python-steamgriddb
          - type: aur
            pkgbase: q4wine
          - type: aur
            pkgbase: qcm-ncm-plugin-git
            devel: true
          - type: aur
            pkgbase: qcmbackend-git
            devel: true
          - type: aur
            pkgbase: qmlmaterial
          - type: aur
            pkgbase: rclone-aliyundrive-git
            devel: true
          - type: aur
            pkgbase: realitlscanner
          - type: aur
            pkgbase: roslyn-ls
          - type: aur
            pkgbase: ruffle-nightly
          - type: aur
            pkgbase: sing-box
          - type: aur
            pkgbase: sing-geoip
          - type: aur
            pkgbase: sing-geosite
          - type: aur
            pkgbase: spicetify-cli
          - type: aur
            pkgbase: spicetify-extensions-rxri-git
            devel: true
          - type: aur
            pkgbase: spicetify-theme-nord-git
            devel: true
          - type: aur
            pkgbase: spicetify-themes-git
            devel: true
          - type: aur
            pkgbase: spotube
            preserve-env: MAKEPKG_SPOTUBE_LASTFM_API_KEY,MAKEPKG_SPOTUBE_LASTFM_API_SECRET
          - type: aur
            pkgbase: systemd-boot-pacman-hook
          - type: aur
            pkgbase: systemd-cron
          - type: aur
            pkgbase: tcp-brutal-dkms
          - type: aur
            pkgbase: thrive
            clean-runner: true
          - type: aur
            pkgbase: unblockneteasemusic-golang-git
            devel: true
          - type: aur
            pkgbase: usbguard-notifier-git
            devel: true
          - type: aur
            pkgbase: vkbasalt-cli
          - type: aur
            pkgbase: vnt
          - type: aur
            pkgbase: watt-toolkit-bin
          - type: aur
            pkgbase: waylyrics
          - type: aur
            pkgbase: web-ext
          - type: aur
            pkgbase: xdg-ninja
          - type: local
            pkgbase: zuban
    runs-on: ${{ matrix.runs-on }}
    name: Build ${{ matrix.package.pkgbase }}
    steps: &steps
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get target arch
        id: target-arch
        run: echo "target-arch=$(uname -m)" >> "$GITHUB_OUTPUT"

      - name: Get PKGBUILD from AUR
        if: matrix.package.type == 'aur'
        uses: ./.github/actions/download-aur-pkgbase
        with:
          pkgbase: ${{ matrix.package.pkgbase }}
          dest: packages/${{ matrix.package.pkgbase }}

      - name: Get makepkg image
        id: download-image
        uses: actions/download-artifact@v7
        with:
          artifact-ids: ${{ needs.prepare.outputs.image-artifact-id }}
          path: ${{ runner.temp }}

      - name: Import makepkg image
        uses: ./.github/actions/setup-makepkg
        with:
          image-path: ${{ steps.download-image.outputs.download-path }}/${{ needs.prepare.outputs.image-filename }}

      - name: Apply patches
        uses: ./.github/actions/apply-patches
        with:
          where: packages/${{ matrix.package.pkgbase }}
          pkgbase: ${{ matrix.package.pkgbase }}

      - name: Generate artifact names
        id: dependency-names
        if: matrix.package.depends
        run: |
          {
            EOF="$(dd if=/dev/urandom bs=15 count=1 status=none | base64)"
            echo "artifact-names<<$EOF"
            jq -r '.[]' <<< '${{ toJSON(matrix.package.depends) }}' | sed 's/^/pkgdest-/g;s/$/-${{ steps.target-arch.outputs.target-arch }}/;'
            echo "$EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate repository
        if: matrix.package.depends
        uses: ./.github/actions/setup-repo
        with:
          artifact-names: ${{ steps.dependency-names.outputs.artifact-names }}
          where: ${{ github.workspace }}/repo

      - name: Get srcinfo
        id: srcinfo
        env: &env
          PACKAGER: ${{ vars.PACKAGER }}
          cinnyBase: ${{ vars.CINNYBASE }}
          MAKEPKG_SPOTUBE_LASTFM_API_KEY: ${{ secrets.MAKEPKG_SPOTUBE_LASTFM_API_KEY }}
          MAKEPKG_SPOTUBE_LASTFM_API_SECRET: ${{ secrets.MAKEPKG_SPOTUBE_LASTFM_API_SECRET }}
        uses: ./.github/actions/execute-makepkg
        with:
          where: packages/${{ matrix.package.pkgbase }}
          preserve-env: ${{ matrix.package.preserve-env }}
          args: --printsrcinfo

      - name: Get required gpg keys
        id: gpg
        run: |
          {
            EOF="$(dd if=/dev/urandom bs=15 count=1 status=none | base64)"
            echo "validpgpkeys<<$EOF"
            grep validpgpkeys '${{ steps.srcinfo.outputs.stdout-path }}' | cut -d = -f 2
            echo "$EOF"  
          } >> "$GITHUB_OUTPUT"

      - name: Fetch required gpg keys
        if: steps.gpg.outputs.validpgpkeys
        uses: ./.github/actions/fetch-gpg-fingerprints
        with:
          fingerprints: ${{ steps.gpg.outputs.validpgpkeys }}
          dest: packages/${{ matrix.package.pkgbase }}/keys/pgp

      - name: Update pkgver and pkgrel
        if: matrix.package.devel
        env: *env
        uses: ./.github/actions/execute-makepkg
        with:
          where: packages/${{ matrix.package.pkgbase }}
          preserve-env: ${{ matrix.package.preserve-env }}
          args: ${{ runner.arch != 'X64' && '--ignorearch' || '' }} --nobuild

      - name: Update srcinfo
        if: matrix.package.devel
        id: srcinfo-updated
        env: *env
        uses: ./.github/actions/execute-makepkg
        with:
          where: packages/${{ matrix.package.pkgbase }}
          preserve-env: ${{ matrix.package.preserve-env }}
          args: --printsrcinfo

      - name: Cache built package
        id: cache
        uses: actions/cache@v4
        with:
          path: pkgdest
          key: pkgdest-${{ matrix.package.pkgbase }}-${{ steps.target-arch.outputs.target-arch }}-${{ hashFiles(format('packages/{0}/PKGBUILD', matrix.package.pkgbase)) }}

      - name: Clean runner
        if: matrix.package.clean-runner && steps.cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/clean-runner

      - name: Set swap
        if: matrix.package.set-swap && steps.cache.outputs.cache-hit != 'true'
        run: |
          swapon --show

          while read -r swap
          do
            echo "Swapping off $swap..."
            sudo swapoff "$swap"
            sudo rm -f "$swap"
          done < <(swapon --noheadings --show=name)
          sudo fallocate --length '${{ matrix.package.set-swap }}' /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile

          swapon --show

      - name: Build package
        if: steps.cache.outputs.cache-hit != 'true'
        env: *env
        uses: ./.github/actions/execute-makepkg
        with:
          where: packages/${{ matrix.package.pkgbase }}
          preserve-env: ${{ matrix.package.preserve-env }}
          args: ${{ runner.arch != 'X64' && '--ignorearch' || '' }}

      - name: List contents to be upload
        run: ls -lR pkgdest

      - name: Upload package
        id: upload
        uses: ./.github/actions/upload-artifacts
        with:
          name: pkgdest-${{ matrix.package.pkgbase }}-${{ steps.target-arch.outputs.target-arch }}
          path: pkgdest

  tier1-packages:
    needs:
      - prepare
      - tier0-packages
    strategy:
      matrix:
        runs-on: ${{ fromJSON(needs.prepare.outputs.runs-on) }}
        package:
          - type: aur
            pkgbase: firefox-extension-plasma-integration
            depends:
              - web-ext
          - type: aur
            pkgbase: fooyin
            depends:
              - libvgm-git
          - type: aur
            pkgbase: libblkmaker
            depends:
              - libbase58
          - type: aur
            pkgbase: patool
            depends:
              - python-setuptools-reproducible
          - type: aur
            pkgbase: protoc-gen-go-grpc
            depends:
              - protoc-gen-go
          - type: aur
            pkgbase: qcm
            depends:
              - cubeb
              - ctre
              - qcmbackend-git
              - qmlmaterial
          - type: aur
            pkgbase: watt-toolkit-git
            depends:
              - dotnet-install
            devel: true
    runs-on: ${{ matrix.runs-on }}
    name: Build ${{ matrix.package.pkgbase }}
    steps: *steps

  tier2-packages:
    needs:
      - prepare
      - tier0-packages
      - tier1-packages
    strategy:
      matrix:
        runs-on: ${{ fromJSON(needs.prepare.outputs.runs-on) }}
        package:
          - type: aur
            pkgbase: bfgminer-git
            depends:
              - libbase58
              - libblkmaker
            devel: true
          - type: local
            pkgbase: local-ai
            depends:
              - go.rice
              - protoc-gen-go
              - protoc-gen-go-grpc
          - type: aur
            pkgbase: bottles
            depends:
              - icoextract
              - python-setuptools-reproducible
              - patool
              - python-fvs
              - python-pathvalidate
              - python-steamgriddb
              - vkbasalt-cli
    runs-on: ${{ matrix.runs-on }}
    name: Build ${{ matrix.package.pkgbase }}
    steps: *steps

  prebuilt-packages:
    needs: prepare
    strategy:
      matrix:
        runs-on: ${{ fromJSON(needs.prepare.outputs.runs-on) }}
        package:
          - type: obs
            pkgbase: ungoogled-chromium-xdg
            project: home:ZhangHua
            package: ungoogled-chromium-xdg
            filter: ungoogled-chromium-xdg
          - type: github
            pkgbase: firefox-xdg
            repo: arenekosreal/firefox-xdg
    runs-on: ${{ matrix.runs-on }}
    name: Download prebuilt ${{ matrix.package.pkgbase }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get target arch
        id: target-arch
        run: echo "target-arch=$(uname -m)" >> "$GITHUB_OUTPUT"

      - name: Install python-yq
        if: matrix.package.type == 'obs'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y yq

      - name: Install Github CLI
        if: matrix.package.type == 'github' && github.event.act.local
        run: |
          sudo mkdir -p -m 755 /etc/apt/keyrings /etc/apt/sources.list.d
          sudo curl https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list
          sudo apt-get update -y
          sudo apt-get install -y gh

      - name: Create pkgdest
        run: mkdir -p pkgdest

      - name: Download GitHub packages
        if: matrix.package.type == 'github'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --dir pkgdest \
            --repo '${{ matrix.package.repo }}' \
            --pattern '*-${{ steps.target-arch.outputs.target-arch }}.pkg.tar.*'

      - name: Download OBS packages
        if: matrix.package.type == 'obs'
        run: |
          API='https://api.opensuse.org/published/${{ matrix.package.project }}/Arch/${{ steps.target-arch.outputs.target-arch }}'
          JQ_QUERY='.directory.entry[]."@name" | select(test("${{ matrix.package.filter }}.+-${{ steps.target-arch.outputs.target-arch }}.pkg.tar.[0-9a-zA-Z]+$"))'
          echo "::debug::API endpoint: $API"
          echo "::debug::JQ query: $JQ_QUERY"
          while read -r name
          do
            curl -L -u '${{ secrets.OBS_USERNAME }}:${{ secrets.OBS_PASSWORD }}' "$API/$name" -o "pkgdest/$name"
            echo "Downloaded pkgdest/$name."
          done < <(curl -L -u '${{ secrets.OBS_USERNAME }}:${{ secrets.OBS_PASSWORD }}' -H 'Accept: application/xml; charset=utf-8' "$API" | xq-python -r "$JQ_QUERY")

      - name: Clean downloaded packages
        run: |
          find pkgdest -maxdepth 1 -type f ! -regex 'pkgdest/.+.pkg.tar.[0-9a-zA-Z]+$' \
            -printf 'Removing %f...\n' \
            -delete

      - name: Generate metadata
        id: meta
        run: echo 'artifact-name=pkgdest-${{ matrix.package.pkgbase }}-${{ steps.target-arch.outputs.target-arch }}' >> "$GITHUB_OUTPUT"

      - name: Upload package
        id: upload
        uses: ./.github/actions/upload-artifacts
        with:
          name: ${{ steps.meta.outputs.artifact-name }}
          path: pkgdest

  release:
    needs:
      - prepare
      - tier0-packages
      - tier1-packages
      - tier2-packages
      - prebuilt-packages
    strategy:
      matrix:
        runs-on: ${{ fromJSON(needs.prepare.outputs.runs-on) }}
    runs-on: ${{ matrix.runs-on }}
    permissions:
      contents: write
    name: Generate and release repository
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get target arch
        id: target-arch
        run: echo "target-arch=$(uname -m)" >> "$GITHUB_OUTPUT"

      - name: Import GPG private key
        id: import-gpg
        run: |
          GPG=(gpg --batch --yes --passphrase '${{ secrets.GPG_PRIVATE_KEY_PASSWORD }}')
          fingerprint="$("${GPG[@]}" --import --import-options import-show --with-colons <<< '${{ secrets.GPG_PRIVATE_KEY }}' | grep '^sec' | cut -d : -f 5)"
          {
            echo "fingerprint=$fingerprint"
            EOF="$(dd if=/dev/urandom bs=15 count=1 status=none | base64)"
            echo "public-key<<$EOF"
            "${GPG[@]}" --export --armor "$fingerprint" 
            echo "$EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate repository
        uses: ./.github/actions/setup-repo
        with:
          artifact-pattern: pkgdest-*-${{ steps.target-arch.outputs.target-arch }}
          repo-name: ${{ github.repository_owner }}
          where: ${{ github.workspace }}/${{ github.repository_owner }}
          gpg-fingerprint: ${{ steps.import-gpg.outputs.fingerprint }}
          gpg-password: ${{ secrets.GPG_PRIVATE_KEY_PASSWORD }}

      - name: Generate notes
        run: |
          {
            echo '## Usage:'
            echo '1. Setup a domain which webserver can redirect any request url contains `:` to `.`.'
            echo 'For example, see [cloudflare-worker](../../../tree/os/${{ steps.target-arch.outputs.target-arch }}/cloudflare-worker)'
            echo ''
            echo '2. Update `pacman.conf` by appending follows:'
            echo '```'
            echo '[${{ github.repository_owner }}]'
            echo 'Server = <DOMAIN>/${{ github.repository_owner }}/os/${{ steps.target-arch.outputs.target-arch }}'
            echo '```'
            echo ''
            echo '3. Import and trust this public key by using `pacman-key`:'
            echo '```'
            echo '${{ steps.import-gpg.outputs.public-key }}'
            echo '```'
          } > notes.md

      - name: Show repository status
        run: ls -l '${{ github.workspace }}/${{ github.repository_owner }}'

      - name: Remove existing release
        if: ${{ ! github.event.act.local }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking existing release..."
          if gh release view 'os/${{ steps.target-arch.outputs.target-arch }}'
          then
            echo "Removing existing release..."
            gh release delete 'os/${{ steps.target-arch.outputs.target-arch }}' --cleanup-tag --yes
          fi
        

      - name: Release
        if: ${{ ! github.event.act.local }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating release..."
          gh release create 'os/${{ steps.target-arch.outputs.target-arch }}' \
            --notes-file notes.md \
            --title 'Release for os/${{ steps.target-arch.outputs.target-arch }}' \
            --draft
          echo "Uploading files..."          
          # https://github.com/cli/cli/issues/9586
          MAX_PARALLEL=70
          while read -r line
          do
            gh release upload 'os/${{ steps.target-arch.outputs.target-arch }}' $line
            sleep 1
          done < <(ls -1 '${{ github.workspace }}/${{ github.repository_owner }}' | sed 's|^|${{ github.workspace }}/${{ github.repository_owner }}/|' | xargs -n "$MAX_PARALLEL")
          echo "Finalizing release..."
          gh release edit 'os/${{ steps.target-arch.outputs.target-arch }}' --draft=false

      - name: Save
        if: github.event.act.local
        run: |
          mkdir -p '/act/out/${{ github.repository_owner }}/os/${{ steps.target-arch.outputs.target-arch }}'
          cp -a --target-directory '/act/out/${{ github.repository_owner }}/os/${{ steps.target-arch.outputs.target-arch }}' \
            '${{ github.workspace }}/${{ github.repository_owner }}/.'
