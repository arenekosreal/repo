name: Bump aur packages' pkgver
on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:
jobs:
  ruffle-nightly:
    name: Bump aur/ruffle-nightly
    runs-on: ubuntu-latest
    steps:
      - name: Get target tag
        id: target-tag
        run: |
          echo -n tag=nightly- >> "$GITHUB_OUTPUT"
          date -u +%F >> "$GITHUB_OUTPUT"
      - name: Check if tag exists
        id: check-tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo -n tag= >> "$GITHUB_OUTPUT"
          target_tag="${{ steps.target-tag.outputs.tag }}"
          gh release --repo ruffle-rs/ruffle list \
            --json tagName \
            --jq ".[] | select(.tagName == \"$target_tag\") | .tagName" \
            --exclude-drafts \
          >> "$GITHUB_OUTPUT"
      - name: Setup SSH
        if: steps.check-tag.outputs.tag
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
      - name: Setup Git
        if: steps.check-tag.outputs.tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      - name: Clone repository
        if: steps.check-tag.outputs.tag
        run: |
          git clone ssh://aur@aur.archlinux.org/ruffle-nightly.git
      - name: Update pkgver
        if: steps.check-tag.outputs.tag
        run:
          current_tag="${{ steps.check-tag.outputs.tag }}"
          target_tag="${{ steps.target-tag.outputs.tag }}"
          sed -i "s/_date=$current_tag/_date=$target_tag/" \
            ruffle-nightly/PKGBUILD
          git -C ruffle-nightly commit -m "Bump to $target_tag"
      - name: Patch source
        if: steps.check-tag.outputs.tag
        run: |
          find "patches/ruffle-nightly" \
            -maxdepth 1 -mindepth 1 -type f \
            -name '*.patch' -o -name '*.diff' |\
          while read -r p
          do
            echo "Applying patch $p..."
            patch -Np1 -d ruffle-nightly -i "../$p"
          done
      - name: Try build
        if: steps.check-tag.outputs.tag
        uses: arenekosreal/makepkg-action@v0.2.1
        with:
          builddir: ruffle-nightly
      - name: Check if needs to push
        id: needs-push
        run: |
          git -C ruffle-nightly reset --hard
          count="$(git -C ruffle-nightly rev-list --count origin/master..HEAD)"
          if [[ "$count" -gt 0 ]]
          then
            echo "result=true" >> "$GITHUB_OUTPUT"
          else
            echo "result=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Push to AUR
        if: steps.needs-push.outputs.result == 'true'
        run: |
          git -C ruffle-nightly push
